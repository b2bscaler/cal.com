services:
  calcom:
    build:
      context: ..
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_WEBAPP_URL: ${NEXT_PUBLIC_WEBAPP_URL}
        NEXT_PUBLIC_WEBSITE_URL: ${NEXT_PUBLIC_WEBSITE_URL}
        NEXTAUTH_URL: ${NEXTAUTH_URL}
        WEBAPP_URL: ${WEBAPP_URL}

    restart: always

    command:
      - sh
      - -c
      - |
          set -e
          copy_app_store() {
            DEST="$$1"
            mkdir -p "$$DEST/app-store" || return 0
            for APP_DIR in /calcom/packages/app-store/*; do
              SLUG="$$(basename "$$APP_DIR")"
              [ -d "$$APP_DIR/static" ] || continue
              rm -rf "$$DEST/app-store/$$SLUG" 2>/dev/null || true
              mkdir -p "$$DEST/app-store/$$SLUG" || continue
              cp -r "$$APP_DIR/static/." "$$DEST/app-store/$$SLUG/" 2>/dev/null || true
            done
          }
          copy_app_store /calcom/apps/web/public || true
          yarn start

    environment:
      NODE_ENV: "${NODE_ENV}"
      DATABASE_URL: "${DATABASE_URL}"
      DATABASE_DIRECT_URL: "${DATABASE_DIRECT_URL}"
      NEXTAUTH_SECRET: "${NEXTAUTH_SECRET}"
      CALENDSO_ENCRYPTION_KEY: "${CALENDSO_ENCRYPTION_KEY}"
      NEXT_PUBLIC_WEBAPP_URL: "${NEXT_PUBLIC_WEBAPP_URL}"
      NEXT_PUBLIC_WEBSITE_URL: "${NEXT_PUBLIC_WEBSITE_URL}"
      NEXTAUTH_URL: "${NEXTAUTH_URL}"
      WEBAPP_URL: "${WEBAPP_URL}"
      NEXTAUTH_URL_INTERNAL: "${NEXTAUTH_URL_INTERNAL}"

networks:
  dokploy-network:
    external: true
