services:
  calcom:
    image: calcom-b2bscaler:latest
    build:
      context: ..
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_WEBAPP_URL: https://cal.b2bscaler.com
        NEXT_PUBLIC_WEBSITE_URL: https://cal.b2bscaler.com
        NEXTAUTH_URL: https://cal.b2bscaler.com
        WEBAPP_URL: https://cal.b2bscaler.com

    restart: always

    command:
      - sh
      - -c
      - |
          set -e
          copy_app_store() {
            DEST="$$1"
            mkdir -p "$$DEST/app-store" || return 0
            for APP_DIR in /calcom/packages/app-store/*; do
              SLUG="$$(basename "$$APP_DIR")"
              [ -d "$$APP_DIR/static" ] || continue
              rm -rf "$$DEST/app-store/$$SLUG" 2>/dev/null || true
              mkdir -p "$$DEST/app-store/$$SLUG" || continue
              cp -r "$$APP_DIR/static/." "$$DEST/app-store/$$SLUG/" 2>/dev/null || true
            done
          }
          copy_app_store /calcom/apps/web/public || true
          yarn start

    environment:
      NODE_ENV: production
      NEXT_PUBLIC_WEBAPP_URL: https://cal.b2bscaler.com
      NEXT_PUBLIC_WEBSITE_URL: https://cal.b2bscaler.com
      NEXTAUTH_URL: https://cal.b2bscaler.com
      WEBAPP_URL: https://cal.b2bscaler.com
      # (keep the rest in Dokploy env UI: DB, secrets, email, etc.)

networks:
  dokploy-network:
    external: true
